#!/usr/bin/env python3

import logging
import requests

from util import elevate_writefile


log = logging.getLogger(__name__)


# https://apt.syncthing.net/
def config_debian_repo():
    key_path = '/usr/share/keyrings/syncthing-archive-keyring.gpg'
    url = 'https://syncthing.net/release-key.gpg'
    log.debug(f'downloading syncthing key from {url}')
    with requests.get(url, stream=True) as r:
        r.raise_for_status()
        log.info(f'elevate writing {key_path} for syncthing gpg')
        elevate_writefile(key_path, r.raw)

    apt_src_path = '/etc/apt/sources.list.d/syncthing.list'
    log.info(f'elevate writing {apt_src_path} for apt')
    elevate_writefile(
        apt_src_path, 'deb [signed-by=/usr/share/keyrings/syncthing-archive-keyring.gpg] https://apt.syncthing.net/ syncthing stable')

    # To make sure the system packages do not take preference over those in this repository, you need to adjust the priority/preference.
    elevate_writefile('/etc/apt/preferences.d/syncthing',
                      'Package: *\nPin: origin apt.syncthing.net\nPin-Priority: 990\n')
